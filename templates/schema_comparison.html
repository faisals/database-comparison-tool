{% extends "base.html" %}

{% block title %}Schema Comparison Results{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1>Database Schema Comparison</h1>
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Compared Databases</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Source Database:</h6>
                    <p><strong>{{ conn1.name }}</strong> ({{ conn1.server }}/{{ conn1.database }})</p>
                </div>
                <div class="col-md-6">
                    <h6>Target Database:</h6>
                    <p><strong>{{ conn2.name }}</strong> ({{ conn2.server }}/{{ conn2.database }})</p>
                </div>
            </div>
        </div>
    </div>
    
    {% if comparison_in_progress %}
    <!-- Progress Section -->
    <div class="card mb-4" id="progressCard">
        <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">Comparison Progress</h5>
        </div>
        <div class="card-body">
            <div class="progress mb-3" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div class="d-flex justify-content-between">
                <p id="progressStatus">Connecting to databases...</p>
                <p id="tableCounter">0 of 0 tables processed</p>
            </div>
            <div id="currentTableName" class="text-center font-weight-bold"></div>
        </div>
    </div>
    {% endif %}
    
    <div class="card mb-4" id="resultsCard" {% if comparison_in_progress %}style="display: none;"{% endif %}>
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Tables Comparison Summary</h5>
            <div>
                <button class="btn btn-sm btn-light" id="showAllTables">Show All Tables</button>
                <button class="btn btn-sm btn-warning" id="showDifferencesOnly">Show Differences Only</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tablesComparisonTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Table Name</th>
                            <th>Source Database</th>
                            <th>Target Database</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                        {% if not comparison_in_progress %}
                        {% for table in schema_comparison %}
                        <tr class="{% if table.differences %}table-row-diff{% else %}table-row-same{% endif %}">
                            <td>{{ table.table_name }}</td>
                            <td>
                                {% if table.in_db1 %}
                                    <span class="badge bg-success">Present</span>
                                {% else %}
                                    <span class="badge bg-danger">Missing</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if table.in_db2 %}
                                    <span class="badge bg-success">Present</span>
                                {% else %}
                                    <span class="badge bg-danger">Missing</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not table.differences %}
                                    <span class="badge bg-success">Identical</span>
                                {% else %}
                                    <span class="badge bg-warning">Differences Found</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if table.in_db1 and table.in_db2 %}
                                    <button class="btn btn-sm btn-primary toggle-details" data-table="{{ table.table_name }}">
                                        Show Details
                                    </button>
                                {% else %}
                                    <span class="text-muted">Not comparable</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if table.in_db1 and table.in_db2 %}
                        <tr class="details-row" id="details-{{ table.table_name|replace(' ', '_')|replace('.', '_') }}" style="display: none;">
                            <td colspan="5">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead class="table-secondary">
                                            <tr>
                                                <th>Column Name</th>
                                                <th>Source Database</th>
                                                <th>Target Database</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for column in table.columns %}
                                            <tr class="{% if column.differences %}table-warning{% endif %}">
                                                <td>{{ column.column_name }}</td>
                                                <td>
                                                    {% if column.in_db1 %}
                                                        {{ column.source.formatted_data_type }}
                                                        {% if column.source.is_nullable == 'No' %}<span class="badge bg-secondary">NOT NULL</span>{% endif %}
                                                        {% if column.source.is_primary_key == 'Yes' %}<span class="badge bg-info">PK</span>{% endif %}
                                                        {% if column.source.is_identity == 'Yes' %}<span class="badge bg-dark">Identity</span>{% endif %}
                                                    {% else %}
                                                        <span class="badge bg-danger">Missing</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if column.in_db2 %}
                                                        {{ column.target.formatted_data_type }}
                                                        {% if column.target.is_nullable == 'No' %}<span class="badge bg-secondary">NOT NULL</span>{% endif %}
                                                        {% if column.target.is_primary_key == 'Yes' %}<span class="badge bg-info">PK</span>{% endif %}
                                                        {% if column.target.is_identity == 'Yes' %}<span class="badge bg-dark">Identity</span>{% endif %}
                                                    {% else %}
                                                        <span class="badge bg-danger">Missing</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if not column.differences %}
                                                        <span class="badge bg-success">Identical</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">Different</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="d-flex justify-content-between mb-4">
        <a href="{{ url_for('comparison.select_comparison_type') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Comparison Type
        </a>
        <a href="{{ url_for('main.index') }}" class="btn btn-primary">
            <i class="fas fa-home"></i> Return to Home
        </a>
    </div>
</div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle details rows
        function setupToggleDetails() {
            document.querySelectorAll('.toggle-details').forEach(button => {
                button.addEventListener('click', function() {
                    const tableName = this.getAttribute('data-table');
                    const detailsRow = document.getElementById('details-' + tableName.replace(/\s/g, '_').replace(/\./g, '_'));
                    
                    if (detailsRow.style.display === 'none') {
                        detailsRow.style.display = 'table-row';
                        this.textContent = 'Hide Details';
                    } else {
                        detailsRow.style.display = 'none';
                        this.textContent = 'Show Details';
                    }
                });
            });
        }
        
        // Track filter state
        let showDifferencesOnly = false;
        
        // Function to apply current filter state to all table rows
        function applyTableFilter() {
            const tableRows = document.querySelectorAll('#comparisonTableBody > tr:not(.details-row)');
            
            tableRows.forEach(row => {
                if (showDifferencesOnly) {
                    // If showing differences only, hide rows without differences
                    if (row.classList.contains('table-row-same')) {
                        row.style.display = 'none';
                    } else {
                        row.style.display = 'table-row';
                    }
                } else {
                    // Show all rows
                    row.style.display = 'table-row';
                }
            });
        }
        
        // Show only differences
        document.getElementById('showDifferencesOnly').addEventListener('click', function() {
            showDifferencesOnly = true;
            applyTableFilter();
        });
        
        // Show all tables
        document.getElementById('showAllTables').addEventListener('click', function() {
            showDifferencesOnly = false;
            applyTableFilter();
        });

        {% if comparison_in_progress %}
        // Dynamic loading of comparison results
        let offset = 0;
        const limit = 5; // Number of tables to process in each batch
        let allTables = [];
        let totalTables = 0;
        let isComplete = false;

        // Function to create table row HTML
        function createTableRow(table) {
            const rowClass = table.differences ? 'table-row-diff' : 'table-row-same';
            
            let html = `
                <tr class="${rowClass}">
                    <td>${table.table_name}</td>
                    <td>
                        ${table.in_db1 
                            ? '<span class="badge bg-success">Present</span>' 
                            : '<span class="badge bg-danger">Missing</span>'}
                    </td>
                    <td>
                        ${table.in_db2 
                            ? '<span class="badge bg-success">Present</span>' 
                            : '<span class="badge bg-danger">Missing</span>'}
                    </td>
                    <td>
                        ${!table.differences 
                            ? '<span class="badge bg-success">Identical</span>' 
                            : '<span class="badge bg-warning">Differences Found</span>'}
                    </td>
                    <td>
                        ${table.in_db1 && table.in_db2 
                            ? '<button class="btn btn-sm btn-primary toggle-details" data-table="' + table.table_name + '">Show Details</button>' 
                            : '<span class="text-muted">Not comparable</span>'}
                    </td>
                </tr>`;
                
            if (table.in_db1 && table.in_db2) {
                const safeTableName = table.table_name.replace(/\s/g, '_').replace(/\./g, '_');
                html += `
                    <tr class="details-row" id="details-${safeTableName}" style="display: none;">
                        <td colspan="5">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-secondary">
                                        <tr>
                                            <th>Column Name</th>
                                            <th>Source Database</th>
                                            <th>Target Database</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                
                table.columns.forEach(column => {
                    const columnClass = column.differences ? 'table-warning' : '';
                    html += `
                        <tr class="${columnClass}">
                            <td>${column.column_name}</td>
                            <td>
                                ${column.in_db1 
                                    ? column.source.formatted_data_type + 
                                      (column.source.is_nullable === 'No' ? '<span class="badge bg-secondary">NOT NULL</span>' : '') +
                                      (column.source.is_primary_key === 'Yes' ? '<span class="badge bg-info">PK</span>' : '') +
                                      (column.source.is_identity === 'Yes' ? '<span class="badge bg-dark">Identity</span>' : '')
                                    : '<span class="badge bg-danger">Missing</span>'}
                            </td>
                            <td>
                                ${column.in_db2 
                                    ? column.target.formatted_data_type + 
                                      (column.target.is_nullable === 'No' ? '<span class="badge bg-secondary">NOT NULL</span>' : '') +
                                      (column.target.is_primary_key === 'Yes' ? '<span class="badge bg-info">PK</span>' : '') +
                                      (column.target.is_identity === 'Yes' ? '<span class="badge bg-dark">Identity</span>' : '')
                                    : '<span class="badge bg-danger">Missing</span>'}
                            </td>
                            <td>
                                ${!column.differences 
                                    ? '<span class="badge bg-success">Identical</span>' 
                                    : '<span class="badge bg-warning">Different</span>'}
                            </td>
                        </tr>`;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>`;
            }
            
            return html;
        }

        // Function to update progress UI
        function updateProgress(progress, processedTables, totalTables, currentTable) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const tableCounter = document.getElementById('tableCounter');
            const currentTableName = document.getElementById('currentTableName');
            
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = progress + '%';
            
            tableCounter.textContent = processedTables + ' of ' + totalTables + ' tables processed';
            
            if (currentTable) {
                progressStatus.textContent = 'Processing table: ' + currentTable;
                currentTableName.textContent = currentTable;
            } else {
                progressStatus.textContent = 'Initializing comparison...';
                currentTableName.textContent = '';
            }
            
            if (progress >= 100) {
                progressStatus.textContent = 'Comparison complete!';
                currentTableName.textContent = '';
                
                // Hide progress card after a delay
                setTimeout(() => {
                    document.getElementById('progressCard').style.display = 'none';
                }, 2000);
            }
        }

        // Function to fetch comparison results
        function fetchComparisonResults() {
            if (isComplete) return;
            
            const url = `/comparison/api/schema_comparison_progress?offset=${offset}&limit=${limit}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        totalTables = data.total_tables;
                        
                        // Update progress
                        updateProgress(
                            data.progress, 
                            data.processed_tables, 
                            data.total_tables,
                            data.current_batch.length > 0 ? data.current_batch[data.current_batch.length - 1].table_name : null
                        );
                        
                        // Add tables to the results table
                        const tableBody = document.getElementById('comparisonTableBody');
                        
                        data.current_batch.forEach(table => {
                            // Check if this table is already in allTables array
                            const existingTableIndex = allTables.findIndex(t => t.table_name === table.table_name);
                            if (existingTableIndex === -1) {
                                // Table doesn't exist yet, add it
                                allTables.push(table);
                                
                                // Add the row HTML
                                tableBody.innerHTML += createTableRow(table);
                            }
                        });
                        
                        // Setup toggle details for new rows
                        setupToggleDetails();
                        
                        // Apply current filter state to all rows
                        applyTableFilter();
                        
                        // Show results card if we have data
                        if (allTables.length > 0) {
                            document.getElementById('resultsCard').style.display = 'block';
                        }
                        
                        // Update offset for next batch
                        offset += data.current_batch.length;
                        
                        // Check if we're done
                        isComplete = data.is_complete;
                        
                        if (!isComplete) {
                            // Continue fetching more results
                            setTimeout(fetchComparisonResults, 500);
                        }
                    } else {
                        console.error('Error:', data.message);
                        document.getElementById('progressStatus').textContent = 'Error: ' + data.message;
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    document.getElementById('progressStatus').textContent = 'Error: ' + error.message;
                });
        }

        // Start fetching comparison results
        setTimeout(fetchComparisonResults, 1000);
        {% else %}
        // Set up toggle details for static content
        setupToggleDetails();
        {% endif %}
    });
</script>
{% endblock %}
{% endblock %}
