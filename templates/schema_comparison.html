{% extends "base.html" %}

{% block title %}CORAL - Schema Comparison Results{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">Database Schema Comparison</h1>
    
    <!-- Comparison Details Card -->
    <div class="coral-card mb-4">
        <div class="coral-card-header">
            <h4 class="mb-0">Comparison Details</h4>
        </div>
        <div class="coral-card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Source Database:</h6>
                    <p><strong>{{ conn1.name }}</strong> <span class="text-muted">({{ conn1.server }}/{{ conn1.database }})</span></p>
                </div>
                <div class="col-md-6">
                    <h6>Target Database:</h6>
                    <p><strong>{{ conn2.name }}</strong> <span class="text-muted">({{ conn2.server }}/{{ conn2.database }})</span></p>
                </div>
            </div>
        </div>
    </div>
    
    {% if comparison_in_progress %}
    <!-- Progress Section -->
    <div class="coral-card mb-4" id="progressCard">
        <div class="coral-card-header">
            <h4 class="mb-0">Comparison Progress</h4>
        </div>
        <div class="coral-card-body">
            <div class="progress mb-3" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%; background-color: #2196F3;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div class="d-flex justify-content-between">
                <p id="progressStatus">Connecting to databases...</p>
                <p id="tableCounter">0 of 0 tables processed</p>
            </div>
            <div id="currentTableName" class="text-center fw-bold"></div>
        </div>
    </div>
    {% endif %}
    
    <!-- Tables Comparison Summary Card -->
    <div class="coral-card mb-4" id="resultsCard" {% if comparison_in_progress %}style="display: none;"{% endif %}>
        <div class="coral-card-header">
            <h4 class="mb-0">Tables Comparison Summary</h4>
            <div class="actions">
                <div class="form-check form-switch d-inline-block me-3">
                    <input class="form-check-input" type="checkbox" id="toggleDifferencesOnly">
                    <label class="form-check-label" for="toggleDifferencesOnly">Show Differences Only</label>
                </div>
                <button class="btn btn-sm btn-outline-secondary" id="showAllTables">
                    <i class="bi bi-table"></i> All Tables
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="showDifferencesOnly">
                    <i class="bi bi-filter"></i> Differences
                </button>
            </div>
        </div>
        <div class="coral-card-body">
            <div class="table-responsive">
                <table class="coral-table coral-table-striped coral-table-hover" id="tablesComparisonTable">
                    <thead>
                        <tr>
                            <th>Table Name</th>
                            <th class="coral-tooltip">
                                Source Database
                                <span class="tooltip-text">Presence in source database</span>
                            </th>
                            <th class="coral-tooltip">
                                Target Database
                                <span class="tooltip-text">Presence in target database</span>
                            </th>
                            <th class="coral-tooltip">
                                Status
                                <span class="tooltip-text">Comparison result status</span>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                        {% if not comparison_in_progress %}
                        {% for table in schema_comparison %}
                        <tr class="{% if table.differences %}diff-modified{% else %}{% endif %} table-row-{% if table.differences %}diff{% else %}same{% endif %}">
                            <td>{{ table.table_name }}</td>
                            <td>
                                {% if table.in_db1 %}
                                    <span class="status-badge status-unchanged">
                                        <i class="bi bi-check-circle-fill"></i> Present
                                    </span>
                                {% else %}
                                    <span class="status-badge status-deleted">
                                        <i class="bi bi-x-circle-fill"></i> Missing
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if table.in_db2 %}
                                    <span class="status-badge status-unchanged">
                                        <i class="bi bi-check-circle-fill"></i> Present
                                    </span>
                                {% else %}
                                    <span class="status-badge status-deleted">
                                        <i class="bi bi-x-circle-fill"></i> Missing
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not table.differences %}
                                    <span class="status-badge status-unchanged">
                                        <i class="bi bi-check-circle-fill"></i> Identical
                                    </span>
                                {% else %}
                                    <span class="status-badge status-modified">
                                        <i class="bi bi-exclamation-circle-fill"></i> Differences
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if table.in_db1 and table.in_db2 %}
                                    <button class="btn btn-sm btn-outline-primary toggle-details" data-table="{{ table.table_name }}">
                                        <i class="bi bi-list-ul"></i> Details
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary view-create-script" data-table="{{ table.table_name }}">
                                        <i class="bi bi-code-slash"></i> SQL
                                    </button>
                                {% else %}
                                    <span class="text-muted">Not comparable</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if table.in_db1 and table.in_db2 %}
                        <tr class="details-row" id="details-{{ table.table_name|replace(' ', '_')|replace('.', '_') }}" style="display: none;">
                            <td colspan="5">
                                <div class="table-responsive">
                                    <table class="coral-table coral-table-striped">
                                        <thead>
                                            <tr>
                                                <th>Column Name</th>
                                                <th>Source Database</th>
                                                <th>Target Database</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for column in table.columns %}
                                            <tr class="{% if column.differences %}diff-modified{% endif %}">
                                                <td>{{ column.column_name }}</td>
                                                <td>
                                                    {% if column.in_db1 %}
                                                        {{ column.source.formatted_data_type }}
                                                        {% if column.source.is_nullable == 'No' %}<span class="status-badge status-unchanged">NOT NULL</span>{% endif %}
                                                        {% if column.source.is_primary_key == 'Yes' %}<span class="status-badge" style="background-color: #2196F3;">PK</span>{% endif %}
                                                        {% if column.source.is_identity == 'Yes' %}<span class="status-badge" style="background-color: #333333;">Identity</span>{% endif %}
                                                    {% else %}
                                                        <span class="status-badge status-deleted">Missing</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if column.in_db2 %}
                                                        {{ column.target.formatted_data_type }}
                                                        {% if column.target.is_nullable == 'No' %}<span class="status-badge status-unchanged">NOT NULL</span>{% endif %}
                                                        {% if column.target.is_primary_key == 'Yes' %}<span class="status-badge" style="background-color: #2196F3;">PK</span>{% endif %}
                                                        {% if column.target.is_identity == 'Yes' %}<span class="status-badge" style="background-color: #333333;">Identity</span>{% endif %}
                                                    {% else %}
                                                        <span class="status-badge status-deleted">Missing</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if not column.differences %}
                                                        <span class="status-badge status-unchanged">
                                                            <i class="bi bi-check-circle-fill"></i> Identical
                                                        </span>
                                                    {% else %}
                                                        <span class="status-badge status-modified">
                                                            <i class="bi bi-exclamation-circle-fill"></i> Different
                                                        </span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- CREATE TABLE Script Comparison Modal -->
    <div class="modal fade" id="scriptComparisonModal" tabindex="-1" aria-labelledby="scriptComparisonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scriptComparisonModalLabel">CREATE TABLE Script Comparison</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Source Database Script</h6>
                            <pre id="sourceScript" class="p-3 bg-light border rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Target Database Script</h6>
                            <pre id="targetScript" class="p-3 bg-light border rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function setupToggleDetails() {
            document.querySelectorAll('.toggle-details').forEach(button => {
                button.addEventListener('click', function() {
                    const tableName = this.getAttribute('data-table');
                    const detailsId = `details-${tableName.replace(/\s/g, '_').replace(/\./g, '_')}`;
                    const detailsRow = document.getElementById(detailsId);
                    
                    if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                        detailsRow.style.display = 'table-row';
                        this.innerHTML = '<i class="bi bi-dash-lg"></i> Hide';
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                    } else {
                        detailsRow.style.display = 'none';
                        this.innerHTML = '<i class="bi bi-list-ul"></i> Details';
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline-primary');
                    }
                });
            });
        }
        
        // Toggle details rows
        setupToggleDetails();
        
        // Set up CREATE TABLE script comparison
        document.querySelectorAll('.view-create-script').forEach(button => {
            button.addEventListener('click', function() {
                const tableName = this.getAttribute('data-table');
                
                // Show loading state
                document.getElementById('sourceScript').textContent = 'Loading...';
                document.getElementById('targetScript').textContent = 'Loading...';
                
                // Show the modal
                const scriptModal = new bootstrap.Modal(document.getElementById('scriptComparisonModal'));
                scriptModal.show();
                
                // Fetch the scripts
                fetch(`/comparison/schema/scripts/${tableName}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('sourceScript').textContent = data.source_script || 'No script available';
                        document.getElementById('targetScript').textContent = data.target_script || 'No script available';
                        
                        // Update modal title
                        document.getElementById('scriptComparisonModalLabel').textContent = `CREATE TABLE Script: ${tableName}`;
                    })
                    .catch(error => {
                        console.error('Error fetching scripts:', error);
                        document.getElementById('sourceScript').textContent = 'Error loading script';
                        document.getElementById('targetScript').textContent = 'Error loading script';
                    });
            });
        });
        
        let showDifferencesOnly = false;
        
        function applyTableFilter() {
            const rows = document.querySelectorAll('#tablesComparisonTable tbody tr:not(.details-row)');
            
            rows.forEach(row => {
                if (showDifferencesOnly) {
                    // If showing only differences, hide rows without differences
                    if (row.classList.contains('table-row-same')) {
                        row.style.display = 'none';
                        
                        // Also hide any associated details row
                        const tableName = row.querySelector('.toggle-details')?.getAttribute('data-table');
                        if (tableName) {
                            const detailsId = `details-${tableName.replace(/\s/g, '_').replace(/\./g, '_')}`;
                            const detailsRow = document.getElementById(detailsId);
                            if (detailsRow) {
                                detailsRow.style.display = 'none';
                            }
                        }
                    } else {
                        row.style.display = '';
                    }
                } else {
                    // Show all rows
                    row.style.display = '';
                }
            });
            
            // Update button states
            if (showDifferencesOnly) {
                document.getElementById('showDifferencesOnly').classList.add('btn-secondary');
                document.getElementById('showDifferencesOnly').classList.remove('btn-outline-secondary');
                document.getElementById('showAllTables').classList.add('btn-outline-secondary');
                document.getElementById('showAllTables').classList.remove('btn-secondary');
            } else {
                document.getElementById('showAllTables').classList.add('btn-secondary');
                document.getElementById('showAllTables').classList.remove('btn-outline-secondary');
                document.getElementById('showDifferencesOnly').classList.add('btn-outline-secondary');
                document.getElementById('showDifferencesOnly').classList.remove('btn-secondary');
            }
        }
        
        // Show all tables
        document.getElementById('showAllTables').addEventListener('click', function() {
            showDifferencesOnly = false;
            applyTableFilter();
        });
        
        // Show only tables with differences
        document.getElementById('showDifferencesOnly').addEventListener('click', function() {
            showDifferencesOnly = true;
            applyTableFilter();
        });
        
        // Toggle differences only checkbox
        document.getElementById('toggleDifferencesOnly').addEventListener('change', function() {
            showDifferencesOnly = this.checked;
            applyTableFilter();
        });
        
        function createTableRow(table) {
            const rowClass = table.differences ? 'diff-modified table-row-diff' : 'table-row-same';
            
            let html = `<tr class="${rowClass}">`;
            html += `<td>${table.table_name}</td>`;
            
            // Source database column
            html += '<td>';
            if (table.in_db1) {
                html += '<span class="status-badge status-unchanged"><i class="bi bi-check-circle-fill"></i> Present</span>';
            } else {
                html += '<span class="status-badge status-deleted"><i class="bi bi-x-circle-fill"></i> Missing</span>';
            }
            html += '</td>';
            
            // Target database column
            html += '<td>';
            if (table.in_db2) {
                html += '<span class="status-badge status-unchanged"><i class="bi bi-check-circle-fill"></i> Present</span>';
            } else {
                html += '<span class="status-badge status-deleted"><i class="bi bi-x-circle-fill"></i> Missing</span>';
            }
            html += '</td>';
            
            // Status column
            html += '<td>';
            if (!table.differences) {
                html += '<span class="status-badge status-unchanged"><i class="bi bi-check-circle-fill"></i> Identical</span>';
            } else {
                html += '<span class="status-badge status-modified"><i class="bi bi-exclamation-circle-fill"></i> Differences</span>';
            }
            html += '</td>';
            
            // Actions column
            html += '<td>';
            if (table.in_db1 && table.in_db2) {
                html += `<button class="btn btn-sm btn-outline-primary toggle-details" data-table="${table.table_name}">`;
                html += '<i class="bi bi-list-ul"></i> Details</button> ';
                html += `<button class="btn btn-sm btn-outline-secondary view-create-script" data-table="${table.table_name}">`;
                html += '<i class="bi bi-code-slash"></i> SQL</button>';
            } else {
                html += '<span class="text-muted">Not comparable</span>';
            }
            html += '</td></tr>';
            
            // Add details row if applicable
            if (table.in_db1 && table.in_db2) {
                const detailsId = `details-${table.table_name.replace(/\s/g, '_').replace(/\./g, '_')}`;
                
                html += `<tr class="details-row" id="${detailsId}" style="display: none;"><td colspan="5">`;
                html += '<div class="table-responsive"><table class="coral-table coral-table-striped">';
                html += '<thead><tr><th>Column Name</th><th>Source Database</th><th>Target Database</th><th>Status</th></tr></thead>';
                html += '<tbody>';
                
                table.columns.forEach(column => {
                    const columnClass = column.differences ? 'diff-modified' : '';
                    
                    html += `<tr class="${columnClass}">`;
                    html += `<td>${column.column_name}</td>`;
                    
                    // Source column details
                    html += '<td>';
                    if (column.in_db1) {
                        html += column.source.formatted_data_type;
                        if (column.source.is_nullable === 'No') {
                            html += ' <span class="status-badge status-unchanged">NOT NULL</span>';
                        }
                        if (column.source.is_primary_key === 'Yes') {
                            html += ' <span class="status-badge" style="background-color: #2196F3;">PK</span>';
                        }
                        if (column.source.is_identity === 'Yes') {
                            html += ' <span class="status-badge" style="background-color: #333333;">Identity</span>';
                        }
                    } else {
                        html += '<span class="status-badge status-deleted">Missing</span>';
                    }
                    html += '</td>';
                    
                    // Target column details
                    html += '<td>';
                    if (column.in_db2) {
                        html += column.target.formatted_data_type;
                        if (column.target.is_nullable === 'No') {
                            html += ' <span class="status-badge status-unchanged">NOT NULL</span>';
                        }
                        if (column.target.is_primary_key === 'Yes') {
                            html += ' <span class="status-badge" style="background-color: #2196F3;">PK</span>';
                        }
                        if (column.target.is_identity === 'Yes') {
                            html += ' <span class="status-badge" style="background-color: #333333;">Identity</span>';
                        }
                    } else {
                        html += '<span class="status-badge status-deleted">Missing</span>';
                    }
                    html += '</td>';
                    
                    // Status column
                    html += '<td>';
                    if (!column.differences) {
                        html += '<span class="status-badge status-unchanged"><i class="bi bi-check-circle-fill"></i> Identical</span>';
                    } else {
                        html += '<span class="status-badge status-modified"><i class="bi bi-exclamation-circle-fill"></i> Different</span>';
                    }
                    html += '</td></tr>';
                });
                
                html += '</tbody></table></div></td></tr>';
            }
            
            return html;
        }
        
        function updateProgress(progress, processedTables, totalTables, currentTable) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const tableCounter = document.getElementById('tableCounter');
            const currentTableName = document.getElementById('currentTableName');
            
            if (progressBar && progressStatus && tableCounter) {
                // Update progress bar
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
                progressBar.textContent = `${progress}%`;
                
                // Update status text
                if (progress < 100) {
                    progressStatus.textContent = 'Comparing tables...';
                } else {
                    progressStatus.textContent = 'Comparison complete!';
                    
                    // Show results card after a short delay
                    setTimeout(() => {
                        document.getElementById('progressCard').style.display = 'none';
                        document.getElementById('resultsCard').style.display = 'block';
                    }, 1000);
                }
                
                // Update table counter
                tableCounter.textContent = `${processedTables} of ${totalTables} tables processed`;
                
                // Update current table name
                if (currentTableName && currentTable) {
                    currentTableName.textContent = `Currently processing: ${currentTable}`;
                }
            }
        }
        
        function fetchComparisonResults(offset = 0, accumulatedResults = []) {
            if (document.getElementById('progressCard')) {
                fetch(`/comparison/schema/status?offset=${offset}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'in_progress') {
                            // Update progress
                            updateProgress(
                                data.progress,
                                data.processed_tables,
                                data.total_tables,
                                data.current_table
                            );
                            
                            // Check again after a delay
                            setTimeout(() => fetchComparisonResults(offset, accumulatedResults), 1000);
                        } else if (data.status === 'complete') {
                            // Combine results
                            const results = [...accumulatedResults, ...data.results];
                            
                            // Check if we need to fetch more results
                            if (data.has_more) {
                                fetchComparisonResults(offset + data.results.length, results);
                            } else {
                                // Update progress to 100%
                                updateProgress(100, data.total_tables, data.total_tables, '');
                                
                                // Render the results
                                const tableBody = document.getElementById('comparisonTableBody');
                                if (tableBody) {
                                    let html = '';
                                    results.forEach(table => {
                                        html += createTableRow(table);
                                    });
                                    tableBody.innerHTML = html;
                                    
                                    // Set up event handlers for the newly created elements
                                    setupToggleDetails();
                                    
                                    // Set up CREATE TABLE script comparison
                                    document.querySelectorAll('.view-create-script').forEach(button => {
                                        button.addEventListener('click', function() {
                                            const tableName = this.getAttribute('data-table');
                                            
                                            // Show loading state
                                            document.getElementById('sourceScript').textContent = 'Loading...';
                                            document.getElementById('targetScript').textContent = 'Loading...';
                                            
                                            // Show the modal
                                            const scriptModal = new bootstrap.Modal(document.getElementById('scriptComparisonModal'));
                                            scriptModal.show();
                                            
                                            // Fetch the scripts
                                            fetch(`/comparison/schema/scripts/${tableName}`)
                                                .then(response => response.json())
                                                .then(data => {
                                                    document.getElementById('sourceScript').textContent = data.source_script || 'No script available';
                                                    document.getElementById('targetScript').textContent = data.target_script || 'No script available';
                                                    
                                                    // Update modal title
                                                    document.getElementById('scriptComparisonModalLabel').textContent = `CREATE TABLE Script: ${tableName}`;
                                                })
                                                .catch(error => {
                                                    console.error('Error fetching scripts:', error);
                                                    document.getElementById('sourceScript').textContent = 'Error loading script';
                                                    document.getElementById('targetScript').textContent = 'Error loading script';
                                                });
                                        });
                                    });
                                    
                                    // Apply initial filter
                                    applyTableFilter();
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching comparison status:', error);
                        // Retry after a delay
                        setTimeout(() => fetchComparisonResults(offset, accumulatedResults), 2000);
                    });
            }
        }
        
        // Start fetching comparison results
        setTimeout(fetchComparisonResults, 1000);
        
        // Set up toggle details for static content
        setupToggleDetails();
        
        // Apply initial filter
        applyTableFilter();
    });
</script>
{% endblock %}
