{% extends "base.html" %}

{% block title %}Schema Comparison Results{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('comparison.select_comparison_type') }}">Compare</a></li>
            <li class="breadcrumb-item active" aria-current="page">Schema Comparison</li>
        </ol>
    </nav>

    <div class="card mb-4">
        <div class="card-header text-white" style="background-color: #2196F3;">
            <h5 class="card-title mb-0">Database Schema Comparison</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Source Database:</h6>
                    <p><strong>{{ conn1.name }}</strong> ({{ conn1.server }}/{{ conn1.database }})</p>
                </div>
                <div class="col-md-6">
                    <h6>Target Database:</h6>
                    <p><strong>{{ conn2.name }}</strong> ({{ conn2.server }}/{{ conn2.database }})</p>
                </div>
            </div>
        </div>
    </div>
    
    {% if comparison_in_progress %}
    <!-- Progress Section -->
    <div class="card mb-4" id="progressCard">
        <div class="card-header text-white" style="background-color: #2196F3;">
            <h5 class="card-title mb-0">Comparison Progress</h5>
        </div>
        <div class="card-body">
            <div class="progress mb-3" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div class="d-flex justify-content-between">
                <p id="progressStatus">Connecting to databases...</p>
                <p id="tableCounter">0 of 0 tables processed</p>
            </div>
            <div id="currentTableName" class="text-center font-weight-bold"></div>
        </div>
    </div>
    {% endif %}
    
    <div class="card mb-4" id="resultsCard" {% if comparison_in_progress %}style="display: none;"{% endif %}>
        <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #2196F3;">
            <h5 class="card-title mb-0">Tables Comparison Summary</h5>
            <div>
                <button class="btn btn-sm btn-light" id="showAllTables">Show All Tables</button>
                <button class="btn btn-sm btn-light" id="showDifferencesOnly">Show Differences Only</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="tablesComparisonTable">
                    <thead style="background-color: #F5F5F5; color: #333333;">
                        <tr>
                            <th>Table Name</th>
                            <th>Source Database</th>
                            <th>Target Database</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                        {% if not comparison_in_progress %}
                        {% for table in schema_comparison %}
                        <tr class="{% if table.differences %}table-row-diff{% else %}table-row-same{% endif %}">
                            <td>{{ table.table_name }}</td>
                            <td>
                                {% if table.in_db1 %}
                                    <span class="badge bg-success">Present</span>
                                {% else %}
                                    <span class="badge bg-danger">Missing</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if table.in_db2 %}
                                    <span class="badge bg-success">Present</span>
                                {% else %}
                                    <span class="badge bg-danger">Missing</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not table.differences %}
                                    <span class="badge bg-success">Identical</span>
                                {% else %}
                                    <span class="badge bg-warning">Differences Found</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if table.in_db1 and table.in_db2 %}
                                    <button class="btn btn-sm btn-outline-primary toggle-details" data-table="{{ table.table_name }}">
                                        Show Details
                                    </button>
                                {% else %}
                                    <span class="text-muted">Not comparable</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if table.in_db1 and table.in_db2 %}
                        <tr class="details-row" id="details-{{ table.table_name|replace(' ', '_')|replace('.', '_') }}" style="display: none;">
                            <td colspan="5">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead style="background-color: #F5F5F5; color: #333333;">
                                            <tr>
                                                <th>Column Name</th>
                                                <th>Source Database</th>
                                                <th>Target Database</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for column in table.columns %}
                                            <tr class="{% if column.differences %}table-warning{% endif %}">
                                                <td>{{ column.name }}</td>
                                                <td>
                                                    {% if column.in_db1 %}
                                                        <span class="schema-status-unchanged">{{ column.db1_type }}</span>
                                                        {% if column.db1_nullable == 'No' %}<span class="badge bg-secondary">NOT NULL</span>{% endif %}
                                                        {% if column.db1_pk == 'Yes' %}<span class="badge bg-info">PK</span>{% endif %}
                                                        {% if column.db1_identity == 'Yes' %}<span class="badge bg-dark">Identity</span>{% endif %}
                                                    {% else %}
                                                        <span class="badge bg-danger">Missing</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if column.in_db2 %}
                                                        <span class="schema-status-unchanged">{{ column.db2_type }}</span>
                                                        {% if column.db2_nullable == 'No' %}<span class="badge bg-secondary">NOT NULL</span>{% endif %}
                                                        {% if column.db2_pk == 'Yes' %}<span class="badge bg-info">PK</span>{% endif %}
                                                        {% if column.db2_identity == 'Yes' %}<span class="badge bg-dark">Identity</span>{% endif %}
                                                    {% else %}
                                                        <span class="badge bg-danger">Missing</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if not column.differences %}
                                                        <span class="badge bg-success">Identical</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">Different</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="d-flex justify-content-between mb-4">
        <a href="{{ url_for('comparison.select_comparison_type') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Comparison Type
        </a>
        <a href="{{ url_for('main.index') }}" class="btn btn-primary">
            <i class="fas fa-home"></i> Return to Home
        </a>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle details rows
        document.querySelectorAll('.toggle-details').forEach(button => {
            button.addEventListener('click', function() {
                const tableName = this.dataset.table;
                const detailsId = `details-${tableName.replace(/[ .]/g, '_')}`;
                const detailsRow = document.getElementById(detailsId);
                
                if (detailsRow) {
                    if (detailsRow.style.display === 'none') {
                        detailsRow.style.display = '';
                        this.textContent = 'Hide Details';
                    } else {
                        detailsRow.style.display = 'none';
                        this.textContent = 'Show Details';
                    }
                }
            });
        });

        {% if comparison_in_progress %}
        function createTableRow(table) {
            const rowClass = table.differences ? 'table-row-diff' : 'table-row-same';
            const row = document.createElement('tr');
            row.className = rowClass;
            
            row.innerHTML = `
                <td>${table.table_name}</td>
                <td>
                    ${table.in_db1 
                        ? '<span class="badge bg-success">Present</span>'
                        : '<span class="badge bg-danger">Missing</span>'}
                </td>
                <td>
                    ${table.in_db2 
                        ? '<span class="badge bg-success">Present</span>'
                        : '<span class="badge bg-danger">Missing</span>'}
                </td>
                <td>
                    ${!table.differences
                        ? '<span class="badge bg-success">Identical</span>'
                        : '<span class="badge bg-warning">Differences Found</span>'}
                </td>
                <td>
                    ${table.in_db1 && table.in_db2 
                        ? '<button class="btn btn-sm btn-outline-primary toggle-details" data-table="' + table.table_name + '">Show Details</button>'
                        : '<span class="text-muted">Not comparable</span>'}
                </td>
            `;
            
            return row;
        }

        function updateProgress(progress, processedTables, totalTables, currentTable) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const tableCounter = document.getElementById('tableCounter');
            const currentTableName = document.getElementById('currentTableName');
            
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = progress + '%';
            
            progressStatus.textContent = currentTable ? `Processing: ${currentTable}` : 'Connecting to databases...';
            tableCounter.textContent = `${processedTables} of ${totalTables} tables processed`;
            currentTableName.textContent = currentTable || '';
        }

        function fetchComparisonResults() {
            fetch('/comparison/schema/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'in_progress') {
                        updateProgress(
                            data.progress,
                            data.processed_tables,
                            data.total_tables,
                            data.current_table
                        );
                        setTimeout(fetchComparisonResults, 1000);
                    } else if (data.status === 'complete') {
                        document.getElementById('progressCard').style.display = 'none';
                        document.getElementById('resultsCard').style.display = 'block';
                        
                        const tbody = document.getElementById('comparisonTableBody');
                        tbody.innerHTML = '';
                        data.results.forEach(table => tbody.appendChild(createTableRow(table)));
                        
                        // Reinitialize toggle details buttons
                        document.querySelectorAll('.toggle-details').forEach(button => {
                            button.addEventListener('click', function() {
                                const tableName = this.dataset.table;
                                const detailsId = `details-${tableName.replace(/[ .]/g, '_')}`;
                                const detailsRow = document.getElementById(detailsId);
                                if (detailsRow) {
                                    if (detailsRow.style.display === 'none') {
                                        detailsRow.style.display = '';
                                        this.textContent = 'Hide Details';
                                    } else {
                                        detailsRow.style.display = 'none';
                                        this.textContent = 'Show Details';
                                    }
                                }
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching comparison results:', error);
                });
        }

        // Start fetching comparison results
        setTimeout(fetchComparisonResults, 1000);
        {% endif %}

        // Set up filter buttons
        document.getElementById('showAllTables').addEventListener('click', function() {
            document.querySelectorAll('.table-row-same, .table-row-diff').forEach(row => {
                row.style.display = 'table-row';
            });
        });

        document.getElementById('showDifferencesOnly').addEventListener('click', function() {
            document.querySelectorAll('.table-row-same').forEach(row => {
                row.style.display = 'none';
            });
            document.querySelectorAll('.table-row-diff').forEach(row => {
                row.style.display = 'table-row';
            });
        });
    });
</script>
{% endblock %}
